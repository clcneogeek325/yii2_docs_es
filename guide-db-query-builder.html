<!DOCTYPE html>
<html lang="en-US">
<head>
    <meta charset="UTF-8"/>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="language" content="en" />
        <link href="./assets/ef5db663/css/bootstrap.css" rel="stylesheet">
<link href="./assets/c596327a/solarized_light.css" rel="stylesheet">
<link href="./assets/956f8f39/style.css" rel="stylesheet">
<script src="./assets/2f771e29/jquery.js"></script>
<script src="./assets/ef5db663/js/bootstrap.js"></script>
<script src="./assets/b35220fb/jssearch.js"></script>    <title>Constructor de consultas - Trabajar con bases de datos - The Definitive Guide to Yii 2.0</title>
</head>
<body>

<div class="wrap">
    <nav id="w88" class="navbar-inverse navbar-fixed-top navbar" role="navigation"><div class="navbar-header"><button type="button" class="navbar-toggle" data-toggle="collapse" data-target="#w88-collapse"><span class="sr-only">Toggle navigation</span>
<span class="icon-bar"></span>
<span class="icon-bar"></span>
<span class="icon-bar"></span></button><a class="navbar-brand" href="./guide-index.html">The Definitive Guide to Yii 2.0</a></div><div id="w88-collapse" class="collapse navbar-collapse"><ul id="w89" class="navbar-nav nav"><li><a href="./guide-README.html">Guide</a></li></ul><div class="navbar-form navbar-left" role="search">
  <div class="form-group">
    <input id="searchbox" type="text" class="form-control" placeholder="Search">
  </div>
</div>
</div></nav>
    <div id="search-resultbox" style="display: none;" class="modal-content">
        <ul id="search-results">
        </ul>
    </div>

    
<div class="row">
    <div class="col-md-2">
                <div id="navigation" class="list-group"><a class="list-group-item" href="#navigation-72" data-toggle="collapse" data-parent="#navigation">Introducción <b class="caret"></b></a><div id="navigation-72" class="submenu panel-collapse collapse"><a class="list-group-item" href="./guide-intro-yii.html">Acerca de Yii</a>
<a class="list-group-item" href="./guide-intro-upgrade-from-v1.html">Actualizar desde Yii 1.1</a></div>
<a class="list-group-item" href="#navigation-73" data-toggle="collapse" data-parent="#navigation">Primeros pasos <b class="caret"></b></a><div id="navigation-73" class="submenu panel-collapse collapse"><a class="list-group-item" href="./guide-start-installation.html">Instalar Yii</a>
<a class="list-group-item" href="./guide-start-workflow.html">Funcionamiento de aplicaciones</a>
<a class="list-group-item" href="./guide-start-hello.html">Hola a todos</a>
<a class="list-group-item" href="./guide-start-forms.html">Trabajar con formularios</a>
<a class="list-group-item" href="./guide-start-databases.html">Trabajar con bases de datos</a>
<a class="list-group-item" href="./guide-start-gii.html">Generar códigos con Gii</a>
<a class="list-group-item" href="./guide-start-looking-ahead.html">Adentrarse en Yii</a></div>
<a class="list-group-item" href="#navigation-74" data-toggle="collapse" data-parent="#navigation">Estructura de una aplicación <b class="caret"></b></a><div id="navigation-74" class="submenu panel-collapse collapse"><a class="list-group-item" href="./guide-structure-overview.html">Información general</a>
<a class="list-group-item" href="./guide-structure-entry-scripts.html">Script de entrada</a>
<a class="list-group-item" href="./guide-structure-applications.html">Aplicaciones</a>
<a class="list-group-item" href="./guide-structure-application-components.html">Componentes de una aplicación</a>
<a class="list-group-item" href="./guide-structure-controllers.html">Controladores</a>
<a class="list-group-item" href="./guide-structure-models.html">Modelos</a>
<a class="list-group-item" href="./guide-structure-views.html">Vistas</a>
<a class="list-group-item" href="./guide-structure-filters.html">Filtros</a>
<a class="list-group-item" href="./guide-structure-widgets.html">Widgets</a>
<a class="list-group-item" href="./guide-structure-modules.html">Módulos</a>
<a class="list-group-item" href="./guide-structure-assets.html">Assets</a>
<a class="list-group-item" href="./guide-structure-extensions.html">Extensiones</a></div>
<a class="list-group-item" href="#navigation-75" data-toggle="collapse" data-parent="#navigation">Gestión de las peticiones <b class="caret"></b></a><div id="navigation-75" class="submenu panel-collapse collapse"><a class="list-group-item" href="./guide-runtime-overview.html">Información general</a>
<a class="list-group-item" href="./guide-runtime-bootstrapping.html">Bootstrapping</a>
<a class="list-group-item" href="./guide-runtime-routing.html">Routing y Creación de las URL</a>
<a class="list-group-item" href="./guide-runtime-requests.html">Peticiones (Requests)</a>
<a class="list-group-item" href="./guide-runtime-responses.html">Respuestas (Responses)</a>
<a class="list-group-item" href="./guide-runtime-sessions-cookies.html">Sesiones (Sessions) y Cookies</a>
<a class="list-group-item" href="./guide-runtime-handling-errors.html">Gestión de errores</a>
<a class="list-group-item" href="./guide-runtime-logging.html">Registro de anotaciones</a></div>
<a class="list-group-item" href="#navigation-76" data-toggle="collapse" data-parent="#navigation">Conceptos clave <b class="caret"></b></a><div id="navigation-76" class="submenu panel-collapse collapse"><a class="list-group-item" href="./guide-concept-components.html">Componentes</a>
<a class="list-group-item" href="./guide-concept-properties.html">Propiedades</a>
<a class="list-group-item" href="./guide-concept-events.html">Eventos</a>
<a class="list-group-item" href="./guide-concept-behaviors.html">Comportamientos (Behaviors)</a>
<a class="list-group-item" href="./guide-concept-configurations.html">Configuraciones</a>
<a class="list-group-item" href="./guide-concept-aliases.html">Alias</a>
<a class="list-group-item" href="./guide-concept-autoloading.html">Autocarga de clases</a>
<a class="list-group-item" href="./guide-concept-service-locator.html">Localizador de servicios (Service Locator)</a>
<a class="list-group-item" href="./guide-concept-di-container.html">Contenedor de inyección de dependencia</a></div>
<a class="list-group-item active" href="#navigation-77" data-toggle="collapse" data-parent="#navigation">Trabajar con bases de datos <b class="caret"></b></a><div id="navigation-77" class="submenu panel-collapse collapse in"><a class="list-group-item" href="./guide-db-dao.html">Objeto de acceso a datos</a>
<a class="list-group-item active" href="./guide-db-query-builder.html">Constructor de consultas</a>
<a class="list-group-item" href="./guide-db-active-record.html">Active Record</a>
<a class="list-group-item" href="./guide-db-migrations.html">Migraciones</a>
<a class="list-group-item" href="./guide-db-sphinx.html">Sphinx</a>
<a class="list-group-item" href="./guide-db-redis.html">Redis</a>
<a class="list-group-item" href="./guide-db-mongodb.html">MongoDB</a>
<a class="list-group-item" href="./guide-db-elastic-search.html">ElasticSearch</a></div>
<a class="list-group-item" href="#navigation-78" data-toggle="collapse" data-parent="#navigation">Obtener datos de los usuarios <b class="caret"></b></a><div id="navigation-78" class="submenu panel-collapse collapse"><a class="list-group-item" href="./guide-input-forms.html">Crear formularios</a>
<a class="list-group-item" href="./guide-input-validation.html">Validar datos</a>
<a class="list-group-item" href="./guide-input-file-upload.html">Subir archivos</a>
<a class="list-group-item" href="./guide-input-tabular-input.html">Recogida de tabular input</a>
<a class="list-group-item" href="./guide-input-multiple-models.html">Obtener datos para múltiples modelos</a></div>
<a class="list-group-item" href="#navigation-79" data-toggle="collapse" data-parent="#navigation">Visualizar datos <b class="caret"></b></a><div id="navigation-79" class="submenu panel-collapse collapse"><a class="list-group-item" href="./guide-output-formatting.html">Formato de datos</a>
<a class="list-group-item" href="./guide-output-pagination.html">Paginación</a>
<a class="list-group-item" href="./guide-output-sorting.html">Ordenación</a>
<a class="list-group-item" href="./guide-output-data-providers.html">Proveedores de datos</a>
<a class="list-group-item" href="./guide-output-data-widgets.html">Widgets de datos</a>
<a class="list-group-item" href="./guide-output-client-scripts.html">Trabajar con scripts de cliente</a>
<a class="list-group-item" href="./guide-output-theming.html">Temas</a></div>
<a class="list-group-item" href="#navigation-80" data-toggle="collapse" data-parent="#navigation">Seguridad <b class="caret"></b></a><div id="navigation-80" class="submenu panel-collapse collapse"><a class="list-group-item" href="./guide-security-authentication.html">Autenticación</a>
<a class="list-group-item" href="./guide-security-authorization.html">Autorización</a>
<a class="list-group-item" href="./guide-security-passwords.html">Trabajar con contraseñas</a>
<a class="list-group-item" href="./guide-security-auth-clients.html">Autenticar Clientes</a>
<a class="list-group-item" href="./guide-security-best-practices.html">Buenas prácticas</a></div>
<a class="list-group-item" href="#navigation-81" data-toggle="collapse" data-parent="#navigation">Caché <b class="caret"></b></a><div id="navigation-81" class="submenu panel-collapse collapse"><a class="list-group-item" href="./guide-caching-overview.html">Información general</a>
<a class="list-group-item" href="./guide-caching-data.html">Caché de datos</a>
<a class="list-group-item" href="./guide-caching-fragment.html">Caché de fragmentos</a>
<a class="list-group-item" href="./guide-caching-page.html">Caché de páginas</a>
<a class="list-group-item" href="./guide-caching-http.html">Caché HTTP</a></div>
<a class="list-group-item" href="#navigation-82" data-toggle="collapse" data-parent="#navigation">Servicios Web RESTful <b class="caret"></b></a><div id="navigation-82" class="submenu panel-collapse collapse"><a class="list-group-item" href="./guide-rest-quick-start.html">Guía breve</a>
<a class="list-group-item" href="./guide-rest-resources.html">Recursos (Resources)</a>
<a class="list-group-item" href="./guide-rest-controllers.html">Controladores</a>
<a class="list-group-item" href="./guide-rest-routing.html">Gestión de rutas</a>
<a class="list-group-item" href="./guide-rest-response-formatting.html">Formateo de respuestas</a>
<a class="list-group-item" href="./guide-rest-authentication.html">Autenticación</a>
<a class="list-group-item" href="./guide-rest-rate-limiting.html">Límite de Rango</a>
<a class="list-group-item" href="./guide-rest-versioning.html">Gestión de versiones</a>
<a class="list-group-item" href="./guide-rest-error-handling.html">Gestión de errores</a></div>
<a class="list-group-item" href="#navigation-83" data-toggle="collapse" data-parent="#navigation">Herramientas de Desarrollo <b class="caret"></b></a><div id="navigation-83" class="submenu panel-collapse collapse"><a class="list-group-item" href="https://github.com/yiisoft/yii2-debug/blob/master/docs/guide-es/README.md">Depurador y Barra de Herramientas de Depuración</a>
<a class="list-group-item" href="./guide-tool-gii.html">Generación de códigos con Gii</a>
<a class="list-group-item" href="./guide-tool-api-doc.html">Generación de documentación de API</a></div>
<a class="list-group-item" href="#navigation-84" data-toggle="collapse" data-parent="#navigation">Pruebas <b class="caret"></b></a><div id="navigation-84" class="submenu panel-collapse collapse"><a class="list-group-item" href="./guide-test-overview.html">Información general</a>
<a class="list-group-item" href="./guide-test-environment-setup.html">Configuración del entorno de pruebas</a>
<a class="list-group-item" href="./guide-test-unit.html">Pruebas unitarias</a>
<a class="list-group-item" href="./guide-test-functional.html">Pruebas funcionales</a>
<a class="list-group-item" href="./guide-test-acceptance.html">Pruebas de aceptación</a>
<a class="list-group-item" href="./guide-test-fixtures.html">Fixtures</a></div>
<a class="list-group-item" href="#navigation-85" data-toggle="collapse" data-parent="#navigation">Temas especiales <b class="caret"></b></a><div id="navigation-85" class="submenu panel-collapse collapse"><a class="list-group-item" href="./guide-tutorial-advanced-app.html">Plantilla aplicación avanzada</a>
<a class="list-group-item" href="./guide-tutorial-start-from-scratch.html">Creación de una aplicación desde cero</a>
<a class="list-group-item" href="./guide-tutorial-console.html">Comandos de consola</a>
<a class="list-group-item" href="./guide-tutorial-core-validators.html">Validadores del núcleo</a>
<a class="list-group-item" href="./guide-tutorial-i18n.html">Internacionalización</a>
<a class="list-group-item" href="./guide-tutorial-mailing.html">Envío de correos electrónicos</a>
<a class="list-group-item" href="./guide-tutorial-performance-tuning.html">Mejora del rendimiento</a>
<a class="list-group-item" href="./guide-tutorial-shared-hosting.html">Entorno de alojamiento compartido</a>
<a class="list-group-item" href="./guide-tutorial-template-engines.html">Motores de plantillas</a>
<a class="list-group-item" href="./guide-tutorial-yii-integration.html">Trabajar con Código de Terceros</a></div>
<a class="list-group-item" href="#navigation-86" data-toggle="collapse" data-parent="#navigation">Widgets <b class="caret"></b></a><div id="navigation-86" class="submenu panel-collapse collapse"><a class="list-group-item" href="https://github.com/yiisoft/yii2-bootstrap/blob/master/docs/guide-es/README.md">Bootstrap Widgets</a>
<a class="list-group-item" href="https://github.com/yiisoft/yii2-jui/blob/master/docs/guide-es/README.md">Jquery UI Widgets</a></div>
<a class="list-group-item" href="#navigation-87" data-toggle="collapse" data-parent="#navigation">Clases auxiliares <b class="caret"></b></a><div id="navigation-87" class="submenu panel-collapse collapse"><a class="list-group-item" href="./guide-helper-overview.html">Información general</a>
<a class="list-group-item" href="./guide-helper-array.html">ArrayHelper</a>
<a class="list-group-item" href="./guide-helper-html.html">Html</a>
<a class="list-group-item" href="./guide-helper-url.html">Url</a></div></div>    </div>
    <div class="col-md-9 guide-content" role="main">
        <h1>Constructor de Consultas <span id="constructor-de-consultas"></span><a href="#constructor-de-consultas" class="hashlink">&para;</a></h1>
<div class="toc"><ol><li><a href="#metodos-de-consulta">Métodos de Consulta</a></li>
<li><a href="#construccion-de-consultas">Construcción de Consultas</a></li>
<li><a href="#consulta-por-lotes">Consulta por Lotes</a></li></ol></div>
<blockquote class="note"><p><strong>Note: </strong>Esta sección está en desarrollo.</p>
</blockquote>
<p>Yii proporciona una capa de acceso básico a bases de datos como se describe en la sección
<a href="guide-db-dao.html">Objetos de Acceso a Bases de Datos</a>. La capa de acceso a bases de datos proporciona un método de bajo
nivel (low-level) para interaccionar con la base de datos. Aunque a veces puede ser útil la escritura de sentencias
SQLs puras, en otras situaciones puede ser pesado y propenso a errores. Otra manera de tratar con bases de datos puede
ser el uso de Constructores de Consultas (Query Builder). El Constructor de Consultas proporciona un medio orientado a
objetos para generar las consultas que se ejecutarán.</p>
<p>Un uso típico de Constructor de Consultas puede ser el siguiente:</p>
<pre><code class="hljs php language-php"><span class="hljs-variable">$rows</span> = (<span class="hljs-keyword">new</span> \yii\db\Query())
    -&gt;select(<span class="hljs-string">'id, name'</span>)
    -&gt;from(<span class="hljs-string">'user'</span>)
    -&gt;limit(<span class="hljs-number">10</span>)
    -&gt;all();

<span class="hljs-comment">// que es equivalente al siguiente código:</span>

<span class="hljs-variable">$query</span> = (<span class="hljs-keyword">new</span> \yii\db\Query())
    -&gt;select(<span class="hljs-string">'id, name'</span>)
    -&gt;from(<span class="hljs-string">'user'</span>)
    -&gt;limit(<span class="hljs-number">10</span>);

<span class="hljs-comment">//  Crear un comando. Se puede obtener la consulta SQL actual utilizando $command-&gt;sql</span>
<span class="hljs-variable">$command</span> = <span class="hljs-variable">$query</span>-&gt;createCommand();

<span class="hljs-comment">// Ejecutar el comando:</span>
<span class="hljs-variable">$rows</span> = <span class="hljs-variable">$command</span>-&gt;queryAll();
</code></pre>
<h2>Métodos de Consulta <span id="metodos-de-consulta"></span><a href="#metodos-de-consulta" class="hashlink">&para;</a></h2><p>Como se puede observar, primero se debe tratar con <span class="broken-link">yii\db\Query</span>. En realidad, <code>Query</code> sólo se encarga de
representar diversa información de la consulta. La lógica para generar la consulta se efectúa mediante
<span class="broken-link">yii\db\QueryBuilder</span> cuando se llama al método <code>createCommand()</code>, y la ejecución de la consulta la efectúa
<span class="broken-link">yii\db\Command</span>.</p>
<p>Se ha establecido, por convenio, que <span class="broken-link">yii\db\Query</span> proporcione un conjunto de métodos de consulta comunes que
construirán la consulta, la ejecutarán, y devolverán el resultado. Por ejemplo:</p>
<ul>
<li><span class="broken-link">yii\db\Query::all()</span>: construye la consulta, la ejecuta y devuelve todos los resultados en formato de array.</li>
<li><span class="broken-link">yii\db\Query::one()</span>: devuelve la primera fila del resultado.</li>
<li><span class="broken-link">yii\db\Query::column()</span>: devuelve la primera columna del resultado.</li>
<li><span class="broken-link">yii\db\Query::scalar()</span>: devuelve la primera columna en la primera fila del resultado.</li>
<li><span class="broken-link">yii\db\Query::exists()</span>: devuelve un valor indicando si la el resultado devuelve algo.</li>
<li><span class="broken-link">yii\db\Query::count()</span>: devuelve el resultado de la consulta <code>COUNT</code>. Otros métodos similares incluidos
son <code>sum($q)</code>, <code>average($q)</code>, <code>max($q)</code>, <code>min($q)</code>, que soportan las llamadas funciones de agregación. El parámetro
<code>$q</code> es obligatorio en estos métodos y puede ser el nombre de la columna o expresión.</li>
</ul>
<h2>Construcción de Consultas <span id="construccion-de-consultas"></span><a href="#construccion-de-consultas" class="hashlink">&para;</a></h2><p>A continuación se explicará como construir una sentencia SQL que incluya varias clausulas. Para simplificarlo, usamos
<code>$query</code> para representar el objeto <span class="broken-link">yii\db\Query</span>:</p>
<h3><code>SELECT</code> <span id="select"></span><a href="#select" class="hashlink">&para;</a></h3><p>Para formar una consulta <code>SELECT</code> básica, se necesita especificar que columnas y de que tablas se seleccionarán:</p>
<pre><code class="hljs php language-php"><span class="hljs-variable">$query</span>-&gt;select(<span class="hljs-string">'id, name'</span>)
    -&gt;from(<span class="hljs-string">'user'</span>);
</code></pre>
<p>Las opciones de select se pueden especificar como una cadena de texto (string) separada por comas o como un array. La
sintaxis del array es especialmente útil cuando se forma la selección dinámicamente.</p>
<pre><code class="hljs php language-php"><span class="hljs-variable">$query</span>-&gt;select([<span class="hljs-string">'id'</span>, <span class="hljs-string">'name'</span>])
    -&gt;from(<span class="hljs-string">'user'</span>);
</code></pre>
<blockquote class="info"><p><strong>Info: </strong>Se debe usar siempre el formato array si la clausula <code>SELECT</code> contiene expresiones SQL. Esto se debe a
  que una expresión SQL como <code>CONCAT(first_name, last_name) AS full_name</code> puede contener comas. Si se junta con otra
  cadena de texto de otra columna, puede ser que la expresión se divida en varias partes por comas, esto puede
  conllevar a errores.</p>
</blockquote>
<p>Cuando se especifican columnas, se pueden incluir los prefijos de las tablas o alias de columnas, ej.  <code>user.id</code>,
<code>user.id AS user_id</code>. Si se usa un array para especificar las columnas, también se pueden usar las claves del array
para especificar los alias de columna, ej. <code>['user_id' =&gt; 'user.id', 'user_name' =&gt; 'user.name']</code>.</p>
<p>A partir de la versión 2.0.1, también se pueden seleccionar subconsultas como columnas. Por ejemplo:</p>
<pre><code class="hljs php language-php"><span class="hljs-variable">$subQuery</span> = (<span class="hljs-keyword">new</span> Query)-&gt;select(<span class="hljs-string">'COUNT(*)'</span>)-&gt;from(<span class="hljs-string">'user'</span>);
<span class="hljs-variable">$query</span> = (<span class="hljs-keyword">new</span> Query)-&gt;select([<span class="hljs-string">'id'</span>, <span class="hljs-string">'count'</span> =&gt; <span class="hljs-variable">$subQuery</span>])-&gt;from(<span class="hljs-string">'post'</span>);
<span class="hljs-comment">// $query representa la siguiente sentencia SQL:</span>
<span class="hljs-comment">// SELECT `id`, (SELECT COUNT(*) FROM `user`) AS `count` FROM `post`</span>
</code></pre>
<p>Para seleccionar filas distintas, se puede llamar a <code>distinct()</code>, como se muestra a continuación:</p>
<pre><code class="hljs php language-php"><span class="hljs-variable">$query</span>-&gt;select(<span class="hljs-string">'user_id'</span>)-&gt;distinct()-&gt;from(<span class="hljs-string">'post'</span>);
</code></pre>
<h3><code>FROM</code> <span id="from"></span><a href="#from" class="hashlink">&para;</a></h3><p>Para especificar de que tabla(s) se quieren seleccionar los datos, se llama a <code>from()</code>:</p>
<pre><code class="hljs php language-php"><span class="hljs-variable">$query</span>-&gt;select(<span class="hljs-string">'*'</span>)-&gt;from(<span class="hljs-string">'user'</span>);
</code></pre>
<p>Se pueden especificar múltiples tablas usando una cadena de texto separado por comas o un array. Los nombres de tablas
pueden contener prefijos de esquema (ej. <code>'public.user'</code>) y/o alias de tablas (ej. `'user u'). El método
entrecomillara automáticamente los nombres de tablas a menos que contengan algún paréntesis (que significa que se
proporciona la tabla como una subconsulta o una expresión de BD). Por ejemplo:</p>
<pre><code class="hljs php language-php"><span class="hljs-variable">$query</span>-&gt;select(<span class="hljs-string">'u.*, p.*'</span>)-&gt;from([<span class="hljs-string">'user u'</span>, <span class="hljs-string">'post p'</span>]);
</code></pre>
<p>Cuando se especifican las tablas como un array, también se pueden usar las claves de los arrays como alias de tablas
(si una tabla no necesita alias, no se usa una clave en formato texto). Por ejemplo:</p>
<pre><code class="hljs php language-php"><span class="hljs-variable">$query</span>-&gt;select(<span class="hljs-string">'u.*, p.*'</span>)-&gt;from([<span class="hljs-string">'u'</span> =&gt; <span class="hljs-string">'user'</span>, <span class="hljs-string">'p'</span> =&gt; <span class="hljs-string">'post'</span>]);
</code></pre>
<p>Se puede especificar una subconsulta usando un objeto <code>Query</code>. En este caso, la clave del array correspondiente se
usará como alias para la subconsulta.</p>
<pre><code class="hljs php language-php"><span class="hljs-variable">$subQuery</span> = (<span class="hljs-keyword">new</span> Query())-&gt;select(<span class="hljs-string">'id'</span>)-&gt;from(<span class="hljs-string">'user'</span>)-&gt;where(<span class="hljs-string">'status=1'</span>);
<span class="hljs-variable">$query</span>-&gt;select(<span class="hljs-string">'*'</span>)-&gt;from([<span class="hljs-string">'u'</span> =&gt; <span class="hljs-variable">$subQuery</span>]);
</code></pre>
<h3><code>WHERE</code> <span id="where"></span><a href="#where" class="hashlink">&para;</a></h3><p>Habitualmente se seleccionan los datos basándose en ciertos criterios. El Constructor de Consultas tiene algunos
métodos útiles para especificarlos, el más poderoso de estos es <code>where</code>, y se puede usar de múltiples formas.</p>
<p>La manera más simple para aplicar una condición es usar una cadena de texto:</p>
<pre><code class="hljs php language-php"><span class="hljs-variable">$query</span>-&gt;where(<span class="hljs-string">'status=:status'</span>, [<span class="hljs-string">':status'</span> =&gt; <span class="hljs-variable">$status</span>]);
</code></pre>
<p>Cuando se usan cadenas de texto, hay que asegurarse que se unen los parámetros de la consulta, no crear una consulta
mediante concatenación de cadenas de texto. El enfoque anterior es seguro, el que se muestra a continuación, no lo es:</p>
<pre><code class="hljs php language-php"><span class="hljs-variable">$query</span>-&gt;where(<span class="hljs-string">"status=$status"</span>); <span class="hljs-comment">// Peligroso!</span>
</code></pre>
<p>En lugar de enlazar los valores de estado inmediatamente, se puede hacer usando <code>params</code> o <code>addParams</code>:</p>
<pre><code class="hljs php language-php"><span class="hljs-variable">$query</span>-&gt;where(<span class="hljs-string">'status=:status'</span>);
<span class="hljs-variable">$query</span>-&gt;addParams([<span class="hljs-string">':status'</span> =&gt; <span class="hljs-variable">$status</span>]);
</code></pre>
<p>Se pueden establecer múltiples condiciones en <code>where</code> usando el <em>formato hash</em>.</p>
<pre><code class="hljs php language-php"><span class="hljs-variable">$query</span>-&gt;where([
    <span class="hljs-string">'status'</span> =&gt; <span class="hljs-number">10</span>,
    <span class="hljs-string">'type'</span> =&gt; <span class="hljs-number">2</span>,
    <span class="hljs-string">'id'</span> =&gt; [<span class="hljs-number">4</span>, <span class="hljs-number">8</span>, <span class="hljs-number">15</span>, <span class="hljs-number">16</span>, <span class="hljs-number">23</span>, <span class="hljs-number">42</span>],
]);
</code></pre>
<p>El código generará la el siguiente SQL:</p>
<pre><code class="hljs sql language-sql">WHERE (`status` = 10) AND (`type` = 2) AND (`id` IN (4, 8, 15, 16, 23, 42))
</code></pre>
<p>El valor NULO es un valor especial en las bases de datos, y el Constructor de Consultas lo gestiona inteligentemente.
Este código:</p>
<pre><code class="hljs php language-php"><span class="hljs-variable">$query</span>-&gt;where([<span class="hljs-string">'status'</span> =&gt; <span class="hljs-keyword">null</span>]);
</code></pre>
<p>da como resultado la siguiente cláusula WHERE:</p>
<pre><code class="hljs sql language-sql">WHERE (`status` IS NULL)
</code></pre>
<p>También se pueden crear subconsultas con objetos de tipo <code>Query</code> como en el siguiente ejemplo:</p>
<pre><code class="hljs php language-php"><span class="hljs-variable">$userQuery</span> = (<span class="hljs-keyword">new</span> Query)-&gt;select(<span class="hljs-string">'id'</span>)-&gt;from(<span class="hljs-string">'user'</span>);
<span class="hljs-variable">$query</span>-&gt;where([<span class="hljs-string">'id'</span> =&gt; <span class="hljs-variable">$userQuery</span>]);
</code></pre>
<p>que generará el siguiente código SQL:</p>
<pre><code class="hljs sql language-sql">WHERE `id` IN (<span class="hljs-operator"><span class="hljs-keyword">SELECT</span> <span class="hljs-string">`id`</span> <span class="hljs-keyword">FROM</span> <span class="hljs-string">`user`</span>)
</span></code></pre>
<p>Otra manera de usar el método es el formato de operando que es <code>[operator, operand1, operand2, ...]</code>.</p>
<p>El operando puede ser uno de los siguientes (ver también <span class="broken-link">yii\db\QueryInterface::where()</span>):</p>
<ul>
<li><p><code>and</code>: los operandos deben concatenerase usando <code>AND</code>. por ejemplo, <code>['and', 'id=1', 'id=2']</code> generará
<code>id=1 AND id=2</code>. Si el operando es un array, se convertirá en una cadena de texto usando las reglas aquí descritas.
Por ejemplo, <code>['and', 'type=1', ['or', 'id=1', 'id=2']]</code> generará <code>type=1 AND (id=1 OR id=2)</code>. El método no
ejecutará ningún filtrado ni entrecomillado.</p>
</li>
<li><p><code>or</code>: similar al operando <code>and</code> exceptuando que los operando son concatenados usando <code>OR</code>.</p>
</li>
<li><p><code>between</code>: el operando 1 debe ser el nombre de columna, y los operandos 2 y 3 deben ser los valores iniciales y
finales del rango en el que se encuentra la columna. Por ejemplo, <code>['between', 'id', 1, 10]</code> generará
<code>id BETWEEN 1 AND 10</code>.</p>
</li>
<li><p><code>not between</code>: similar a <code>between</code> exceptuando que  <code>BETWEEN</code> se reemplaza por <code>NOT BETWEEN</code> en la condición
generada.</p>
</li>
<li><p><code>in</code>: el operando 1 debe ser una columna o una expresión de BD. El operando 2 puede ser un array o un objeto de tipo
<code>Query</code>. Generará una condición <code>IN</code>. Si el operando 2 es un array, representará el rango de valores que puede
albergar la columna o la expresión de BD; Si el operando 2 es un objeto de tipo <code>Query</code>, se generará una subconsulta
y se usará como rango de la columna o de la expresión de BD. Por ejemplo, <code>['in', 'id', [1, 2, 3]]</code> generará
<code>id IN (1, 2, 3)</code>. El método entrecomillará adecuadamente el nombre de columna y filtrará los valores del rango. El
operando <code>in</code> también soporta columnas compuestas. En este caso, el operando 1 debe se un array de columnas,
mientras que el operando 2 debe ser un array de arrays o un objeto de tipo <code>Query</code> que represente el rango de las
columnas.</p>
</li>
<li><p><code>not in</code>: similar que el operando <code>in</code> exceptuando que <code>IN</code> se reemplaza por <code>NOT IN</code> en la condición generada.</p>
</li>
<li><p><code>like</code>: el operando 1 debe ser una columna o una expresión de BD, y el operando 2 debe ser una cadena de texto o un
array que represente los valores a los que tienen que asemejarse la columna o la expresión de BD.Por ejemplo,
<code>['like', 'name', 'tester']</code> generará <code>name LIKE '%tester%'</code>. Cuando se da el valor rango como un array, se
generarán múltiples predicados <code>LIKE</code> y se concatenaran usando <code>AND</code>. Por ejemplo,
<code>['like', 'name', ['test', 'sample']]</code> generará <code>name LIKE '%test%' AND name LIKE '%sample%'</code>. También se puede
proporcionar un tercer operando opcional para especificar como deben filtrarse los caracteres especiales en los
valores. El operando debe se un array que mapeen los caracteres especiales a sus caracteres filtrados asociados. Si
no se proporciona este operando, se aplicará el mapeo de filtrado predeterminado. Se puede usar <code>false</code> o un array
vacío para indicar que los valores ya están filtrados y no se necesita aplicar ningún filtro. Hay que tener en
cuenta que cuando se usa un el mapeo de filtrado (o no se especifica el tercer operando), los valores se encerraran
automáticamente entre un par de caracteres de porcentaje.</p>
</li>
</ul>
<blockquote class="note"><p><strong>Note: </strong>Cuando se usa PostgreSQL también se puede usar
<a href="http://www.postgresql.org/docs/8.3/static/functions-matching.html#FUNCTIONS-LIKE"><code>ilike</code></a> en lugar de <code>like</code> para
filtrar resultados insensibles a mayúsculas (case-insensitive).</p>
</blockquote>
<ul>
<li><p><code>or like</code>: similar al operando <code>like</code> exceptuando que se usa <code>OR</code> para concatenar los predicados <code>LIKE</code> cuando haya
un segundo operando en un array.</p>
</li>
<li><p><code>not like</code>: similar al operando <code>like</code> exceptuando que se usa <code>LIKE</code> en lugar de <code>NOT LIKE</code> en las condiciones
generadas.</p>
</li>
<li><p><code>or not like</code>: similar al operando <code>not like</code> exceptuando que se usa <code>OR</code> para concatenar los predicados <code>NOT LIKE</code>.</p>
</li>
<li><p><code>exists</code>: requiere un operando que debe ser una instancia de <span class="broken-link">yii\db\Query</span> que represente la subconsulta. Esto
generará una expresión <code>EXISTS (sub-query)</code>.</p>
</li>
<li><p><code>not exists</code>: similar al operando <code>exists</code> y genera una expresión <code>NOT EXISTS (sub-query)</code>.</p>
</li>
</ul>
<p>Adicionalmente se puede especificar cualquier cosa como operando:</p>
<pre><code class="hljs php language-php"><span class="hljs-variable">$query</span>-&gt;select(<span class="hljs-string">'id'</span>)
    -&gt;from(<span class="hljs-string">'user'</span>)
    -&gt;where([<span class="hljs-string">'&gt;='</span>, <span class="hljs-string">'id'</span>, <span class="hljs-number">10</span>]);
</code></pre>
<p>Cuyo resultado será:</p>
<pre><code class="hljs sql language-sql"><span class="hljs-operator"><span class="hljs-keyword">SELECT</span> <span class="hljs-keyword">id</span> <span class="hljs-keyword">FROM</span> <span class="hljs-keyword">user</span> <span class="hljs-keyword">WHERE</span> <span class="hljs-keyword">id</span> &gt;= <span class="hljs-number">10</span>;</span>
</code></pre>
<p>Si se construyen partes de una condición dinámicamente, es muy convenientes usar <code>andWhere()</code> y <code>orWhere()</code>:</p>
<pre><code class="hljs php language-php"><span class="hljs-variable">$status</span> = <span class="hljs-number">10</span>;
<span class="hljs-variable">$search</span> = <span class="hljs-string">'yii'</span>;

<span class="hljs-variable">$query</span>-&gt;where([<span class="hljs-string">'status'</span> =&gt; <span class="hljs-variable">$status</span>]);
<span class="hljs-keyword">if</span> (!<span class="hljs-keyword">empty</span>(<span class="hljs-variable">$search</span>)) {
    <span class="hljs-variable">$query</span>-&gt;andWhere([<span class="hljs-string">'like'</span>, <span class="hljs-string">'title'</span>, <span class="hljs-variable">$search</span>]);
}
</code></pre>
<p>En el caso que <code>$search</code> no este vacío, se generará el siguiente código SQL:</p>
<pre><code class="hljs sql language-sql">WHERE (`status` = 10) AND (`title` LIKE '%yii%')
</code></pre>
<h4>Construcción de Condiciones de Filtro <span id="construccion-de-condiciones-de-filtro"></span><a href="#construccion-de-condiciones-de-filtro" class="hashlink">&para;</a></h4><p>Cuando se generan condiciones de filtro basadas en datos recibidos de usuarios (inputs), a menudo se quieren gestionar
de forma especial las "datos vacíos" para ignorarlos en los filtros. Por ejemplo, teniendo un formulario HTML que
obtiene el nombre de usuario y la dirección de correo electrónico. Si el usuario solo rellena el campo de nombre de
usuario, se puede querer generar una consulta para saber si el nombre de usuario recibido es valido. Se puede usar
<code>filterWhere()</code> para conseguirlo:</p>
<pre><code class="hljs php language-php"><span class="hljs-comment">// $username y $email son campos de formulario rellenados por usuarios</span>
<span class="hljs-variable">$query</span>-&gt;filterWhere([
    <span class="hljs-string">'username'</span> =&gt; <span class="hljs-variable">$username</span>,
    <span class="hljs-string">'email'</span> =&gt; <span class="hljs-variable">$email</span>,
]);
</code></pre>
<p>El método <code>filterWhere()</code> es muy similar al método <code>where()</code>. La principal diferencia es que el <code>filterWhere()</code>
eliminará los valores vacíos de las condiciones proporcionadas. Por lo tanto si <code>$email</code> es "vació", la consulta
resultante será <code>...WHERE username=:username</code>; y si tanto <code>$username</code> como <code>$email</code> son "vacías", la consulta no
tendrá <code>WHERE</code>.</p>
<p>Decimos que un valor es <em>vacío</em> si es nulo, una cadena de texto vacía, una cadena de texto que consista en espacios en
blanco o un array vacío.</p>
<p>También se pueden usar <code>andFilterWhere()</code> y <code>orFilterWhere()</code> para añadir más condiciones de filtro.</p>
<h3><code>ORDER BY</code> <span id="order-by"></span><a href="#order-by" class="hashlink">&para;</a></h3><p>Se pueden usar <code>orderBy</code> y <code>addOrderBy</code> para ordenar resultados:</p>
<pre><code class="hljs php language-php"><span class="hljs-variable">$query</span>-&gt;orderBy([
    <span class="hljs-string">'id'</span> =&gt; SORT_ASC,
    <span class="hljs-string">'name'</span> =&gt; SORT_DESC,
]);
</code></pre>
<p>Aquí estamos ordenando por <code>id</code> ascendente y después por <code>name</code> descendente.</p>
<h3><code>GROUP BY</code> and <code>HAVING</code> <span id="group-by-and-having"></span><a href="#group-by-and-having" class="hashlink">&para;</a></h3><p>Para añadir <code>GROUP BY</code> al SQL generado se puede usar el siguiente código:</p>
<pre><code class="hljs php language-php"><span class="hljs-variable">$query</span>-&gt;groupBy(<span class="hljs-string">'id, status'</span>);
</code></pre>
<p>Si se quieren añadir otro campo después de usar <code>groupBy</code>:</p>
<pre><code class="hljs php language-php"><span class="hljs-variable">$query</span>-&gt;addGroupBy([<span class="hljs-string">'created_at'</span>, <span class="hljs-string">'updated_at'</span>]);
</code></pre>
<p>Para añadir la condición <code>HAVING</code> se pueden usar los métodos <code>having</code> y <code>andHaving</code> y <code>orHaving</code>. Los parámetros para
ellos son similares a los del grupo de métodos <code>where</code>:</p>
<pre><code class="hljs php language-php"><span class="hljs-variable">$query</span>-&gt;having([<span class="hljs-string">'status'</span> =&gt; <span class="hljs-variable">$status</span>]);
</code></pre>
<h3><code>LIMIT</code> and <code>OFFSET</code> <span id="limit-and-offset"></span><a href="#limit-and-offset" class="hashlink">&para;</a></h3><p>Para limitar el resultado a 10 filas se puede usar <code>limit</code>:</p>
<pre><code class="hljs php language-php"><span class="hljs-variable">$query</span>-&gt;limit(<span class="hljs-number">10</span>);
</code></pre>
<p>Para saltarse las 100 primeras filas, se puede usar:</p>
<pre><code class="hljs php language-php"><span class="hljs-variable">$query</span>-&gt;offset(<span class="hljs-number">100</span>);
</code></pre>
<h3><code>JOIN</code> <span id="join"></span><a href="#join" class="hashlink">&para;</a></h3><p>Las clausulas <code>JOIN</code> se generan en el Constructor de Consultas usando el método join aplicable:</p>
<ul>
<li><code>innerJoin()</code></li>
<li><code>leftJoin()</code></li>
<li><code>rightJoin()</code></li>
</ul>
<p>Este left join selecciona los datos desde dos tablas relacionadas en una consulta:</p>
<pre><code class="hljs php language-php"><span class="hljs-variable">$query</span>-&gt;select([<span class="hljs-string">'user.name AS author'</span>, <span class="hljs-string">'post.title as title'</span>])
    -&gt;from(<span class="hljs-string">'user'</span>)
    -&gt;leftJoin(<span class="hljs-string">'post'</span>, <span class="hljs-string">'post.user_id = user.id'</span>);
</code></pre>
<p>En el código, el primer parámetro del método <code>leftjoin</code> especifica la tabla a la que aplicar el join. El segundo
parámetro, define la condición del join.</p>
<p>Si la aplicación de bases de datos soporta otros tipos de joins, se pueden usar mediante el método <code>join</code> genérico:</p>
<pre><code class="hljs php language-php"><span class="hljs-variable">$query</span>-&gt;join(<span class="hljs-string">'FULL OUTER JOIN'</span>, <span class="hljs-string">'post'</span>, <span class="hljs-string">'post.user_id = user.id'</span>);
</code></pre>
<p>El primer argumento es el tipo de join a realizar. El segundo es la tabla a la que aplicar el join, y el tercero es la condición:</p>
<p>Como en <code>FROM</code>, también se pueden efectuar joins con subconsultas. Para hacerlo, se debe especificar la subconsulta
como un array que tiene que contener un elemento. El valor del array tiene que ser un objeto de tipo <code>Query</code> que
represente la subconsulta, mientras que la clave del array es el alias de la subconsulta. Por ejemplo:</p>
<pre><code class="hljs php language-php"><span class="hljs-variable">$query</span>-&gt;leftJoin([<span class="hljs-string">'u'</span> =&gt; <span class="hljs-variable">$subQuery</span>], <span class="hljs-string">'u.id=author_id'</span>);
</code></pre>
<h3><code>UNION</code> <span id="union"></span><a href="#union" class="hashlink">&para;</a></h3><p>En SQL <code>UNION</code> agrega resultados de una consulta a otra consulta. Las columnas devueltas por ambas consultas deben
coincidir. En Yii para construirla, primero se pueden formar dos objetos de tipo query y después usar el método
<code>union</code>:</p>
<pre><code class="hljs php language-php"><span class="hljs-variable">$query</span> = <span class="hljs-keyword">new</span> Query();
<span class="hljs-variable">$query</span>-&gt;select(<span class="hljs-string">"id, category_id as type, name"</span>)-&gt;from(<span class="hljs-string">'post'</span>)-&gt;limit(<span class="hljs-number">10</span>);

<span class="hljs-variable">$anotherQuery</span> = <span class="hljs-keyword">new</span> Query();
<span class="hljs-variable">$anotherQuery</span>-&gt;select(<span class="hljs-string">'id, type, name'</span>)-&gt;from(<span class="hljs-string">'user'</span>)-&gt;limit(<span class="hljs-number">10</span>);

<span class="hljs-variable">$query</span>-&gt;union(<span class="hljs-variable">$anotherQuery</span>);
</code></pre>
<h2>Consulta por Lotes <span id="consulta-por-lotes"></span><a href="#consulta-por-lotes" class="hashlink">&para;</a></h2><p>Cuando se trabaja con grandes cantidades de datos, los métodos como <span class="broken-link">yii\db\Query::all()</span> no son adecuados ya que
requieren la carga de todos los datos en memoria. Para mantener los requerimientos de memoria reducidos, Yii
proporciona soporte a las llamadas consultas por lotes (batch query). Una consulta por lotes usa un cursor de datos y
recupera los datos en bloques.</p>
<p>Las consultas por lotes se pueden usar del siguiente modo:</p>
<pre><code class="hljs php language-php"><span class="hljs-keyword">use</span> <span class="hljs-title">yii</span>\<span class="hljs-title">db</span>\<span class="hljs-title">Query</span>;

<span class="hljs-variable">$query</span> = (<span class="hljs-keyword">new</span> Query())
    -&gt;from(<span class="hljs-string">'user'</span>)
    -&gt;orderBy(<span class="hljs-string">'id'</span>);

<span class="hljs-keyword">foreach</span> (<span class="hljs-variable">$query</span>-&gt;batch() <span class="hljs-keyword">as</span> <span class="hljs-variable">$users</span>) {
    <span class="hljs-comment">// $users is an array of 100 or fewer rows from the user table</span>
}

<span class="hljs-comment">// o si se quieren iterar las filas una a una</span>
<span class="hljs-keyword">foreach</span> (<span class="hljs-variable">$query</span>-&gt;each() <span class="hljs-keyword">as</span> <span class="hljs-variable">$user</span>) {
    <span class="hljs-comment">// $user representa uno fila de datos de la tabla user</span>
}
</code></pre>
<p>Los métodos <span class="broken-link">yii\db\Query::batch()</span> y <span class="broken-link">yii\db\Query::each()</span> devuelven un objeto <span class="broken-link">yii\db\BatchQueryResult</span> que
implementa una interfaz <code>Iterator</code> y así se puede usar en el constructor <code>foreach</code>. Durante la primera iteración, se
efectúa una consulta SQL a la base de datos. Desde entonces, los datos se recuperan por lotes en las iteraciones. El
tamaño predeterminado de los lotes es 100, que significa que se recuperan 100 filas de datos en cada lote. Se puede
modificar el tamaño de los lotes pasando pasando un primer parámetro a los métodos <code>batch()</code> o <code>each()</code>.</p>
<p>En comparación con <span class="broken-link">yii\db\Query::all()</span>, las consultas por lotes sólo cargan 100 filas de datos en memoria cada
vez. Si el procesan los datos y después se descartan inmediatamente, las consultas por lotes, pueden ayudar a mantener
el uso de memora bajo un limite.</p>
<p>Si se especifica que el resultado de la consulta tiene que ser indexado por alguna columna mediante
<span class="broken-link">yii\db\Query::indexBy()</span>, las consultas por lotes seguirán manteniendo el indice adecuado. Por ejemplo,</p>
<pre><code class="hljs php language-php"><span class="hljs-keyword">use</span> <span class="hljs-title">yii</span>\<span class="hljs-title">db</span>\<span class="hljs-title">Query</span>;

<span class="hljs-variable">$query</span> = (<span class="hljs-keyword">new</span> Query())
    -&gt;from(<span class="hljs-string">'user'</span>)
    -&gt;indexBy(<span class="hljs-string">'username'</span>);

<span class="hljs-keyword">foreach</span> (<span class="hljs-variable">$query</span>-&gt;batch() <span class="hljs-keyword">as</span> <span class="hljs-variable">$users</span>) {
    <span class="hljs-comment">// $users esta indexado en la columna "username"</span>
}

<span class="hljs-keyword">foreach</span> (<span class="hljs-variable">$query</span>-&gt;each() <span class="hljs-keyword">as</span> <span class="hljs-variable">$username</span> =&gt; <span class="hljs-variable">$user</span>) {
}
</code></pre>
        <div class="toplink"><a href="#" class="h1" title="go to top"><span class="glyphicon glyphicon-arrow-up"></a></div>
    </div>
</div>


</div>

<footer class="footer">
        <p class="pull-right"><small>Page generated on Wed, 22 Mar 2017 18:28:18 +0000</small></p>
    Powered by <a href="http://www.yiiframework.com/" rel="external">Yii Framework</a></footer>

<script type="text/javascript">jQuery(document).ready(function () {
    var shiftWindow = function () { scrollBy(0, -50) };
    if (location.hash) setTimeout(shiftWindow, 1);
    window.addEventListener("hashchange", shiftWindow);
var element = document.createElement("script");
element.src = "./jssearch.index.js";
document.body.appendChild(element);

var searchBox = $('#searchbox');

// search when typing in search field
searchBox.on("keyup", function(event) {
    var query = $(this).val();

    if (query == '' || event.which == 27) {
        $('#search-resultbox').hide();
        return;
    } else if (event.which == 13) {
        var selectedLink = $('#search-resultbox a.selected');
        if (selectedLink.length != 0) {
            document.location = selectedLink.attr('href');
            return;
        }
    } else if (event.which == 38 || event.which == 40) {
        $('#search-resultbox').show();

        var selected = $('#search-resultbox a.selected');
        if (selected.length == 0) {
            $('#search-results').find('a').first().addClass('selected');
        } else {
            var next;
            if (event.which == 40) {
                next = selected.parent().next().find('a').first();
            } else {
                next = selected.parent().prev().find('a').first();
            }
            if (next.length != 0) {
                var resultbox = $('#search-results');
                var position = next.position();

//              TODO scrolling is buggy and jumps around
//                resultbox.scrollTop(Math.floor(position.top));
//                console.log(position.top);

                selected.removeClass('selected');
                next.addClass('selected');
            }
        }

        return;
    }
    $('#search-resultbox').show();
    $('#search-results').html('<li><span class="no-results">No results</span></li>');

    var result = jssearch.search(query);

    if (result.length > 0) {
        var i = 0;
        var resHtml = '';

        for (var key in result) {
            if (i++ > 20) {
                break;
            }
            resHtml = resHtml +
            '<li><a href="' + result[key].file.u.substr(3) +'"><span class="title">' + result[key].file.t + '</span>' +
            '<span class="description">' + result[key].file.d + '</span></a></li>';
        }
        $('#search-results').html(resHtml);
    }
});

// hide the search results on ESC
$(document).on("keyup", function(event) { if (event.which == 27) { $('#search-resultbox').hide(); } });
// hide search results on click to document
$(document).bind('click', function (e) { $('#search-resultbox').hide(); });
// except the following:
searchBox.bind('click', function(e) { e.stopPropagation(); });
$('#search-resultbox').bind('click', function(e) { e.stopPropagation(); });

});</script></body>
</html>
